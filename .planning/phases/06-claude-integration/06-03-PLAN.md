---
phase: 06-claude-integration
plan: 03
type: execute
wave: 3
depends_on: ["06-02"]
files_modified:
  - src/components/chat/ApiKeyInput/ApiKeyInput.jsx
  - src/components/chat/ApiKeyInput/index.js
  - src/components/chat/index.js
  - src/pages/ManagerDetail/ManagerDetail.jsx
  - src/layouts/AppLayout.jsx
autonomous: true

must_haves:
  truths:
    - "User can enter API key via ApiKeyInput component"
    - "API key persists across page refreshes"
    - "Manager Detail page shows ChatThread below data sections"
    - "AskInput in AppLayout triggers chat in ManagerDetail when on that page"
    - "Clicking follow-up suggestion sends that question"
    - "Conversation persists within session (multiple questions)"
  artifacts:
    - path: "src/components/chat/ApiKeyInput/ApiKeyInput.jsx"
      provides: "API key entry with masked display"
      exports: ["ApiKeyInput"]
    - path: "src/pages/ManagerDetail/ManagerDetail.jsx"
      provides: "Chat section integration"
    - path: "src/layouts/AppLayout.jsx"
      provides: "AskInput wiring to chat"
  key_links:
    - from: "src/pages/ManagerDetail/ManagerDetail.jsx"
      to: "src/hooks/useChat.js"
      via: "useChat hook"
      pattern: "useChat"
    - from: "src/pages/ManagerDetail/ManagerDetail.jsx"
      to: "src/components/chat/ChatThread"
      via: "ChatThread component"
      pattern: "ChatThread"
    - from: "src/layouts/AppLayout.jsx"
      to: "src/stores/chatStore.js"
      via: "useChatStore for sendMessage"
      pattern: "useChatStore"
---

<objective>
Wire chat functionality into the application: add ApiKeyInput component, integrate ChatThread into ManagerDetail page, and connect AppLayout AskInput to chat system.

Purpose: Complete the Claude integration by connecting UI to the chat infrastructure.
Output: Working Ask Anything feature with streaming responses and clickable citations.
</objective>

<execution_context>
@/Users/ericgreene/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ericgreene/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-claude-integration/06-RESEARCH.md
@.planning/phases/06-claude-integration/06-02-SUMMARY.md
@src/hooks/useChat.js
@src/components/chat/ChatThread/ChatThread.jsx
@src/pages/ManagerDetail/ManagerDetail.jsx
@src/layouts/AppLayout.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ApiKeyInput component</name>
  <files>
    src/components/chat/ApiKeyInput/ApiKeyInput.jsx
    src/components/chat/ApiKeyInput/index.js
    src/components/chat/index.js
  </files>
  <action>
    1. Create src/components/chat/ApiKeyInput/ApiKeyInput.jsx:
       - Import useState from 'react'
       - Import useSettingsStore from '@/stores'
       - Get apiKey, setApiKey, clearApiKey from store
       - Local state: inputValue (for editing), isEditing (boolean)
       - Render:
         - If apiKey exists and !isEditing:
           - Show masked display: "sk-...{last4chars}" with "Change" button
           - "Change" button sets isEditing to true
         - If !apiKey or isEditing:
           - Input field (type="password") for API key entry
           - "Save" button that calls setApiKey(inputValue) and sets isEditing to false
           - If isEditing, show "Cancel" button to reset
       - Style: compact inline design, text-sm, rounded border, fits in a settings-like area
       - Add helper text below input: "Your API key is stored locally and never sent to our servers."

    2. Create src/components/chat/ApiKeyInput/index.js barrel export

    3. Update src/components/chat/index.js to also export ApiKeyInput
  </action>
  <verify>
    - `grep "useSettingsStore" src/components/chat/ApiKeyInput/ApiKeyInput.jsx` shows store usage
    - `grep "setApiKey" src/components/chat/ApiKeyInput/ApiKeyInput.jsx` shows save action
    - `grep "type=\"password\"" src/components/chat/ApiKeyInput/ApiKeyInput.jsx` shows masked input
    - `grep "ApiKeyInput" src/components/chat/index.js` shows export
  </verify>
  <done>
    ApiKeyInput allows users to enter and manage their Anthropic API key with secure masked display.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate ChatThread into ManagerDetail page</name>
  <files>src/pages/ManagerDetail/ManagerDetail.jsx</files>
  <action>
    1. Add imports at top:
       - { useChat } from '@/hooks/useChat'
       - { ChatThread, ApiKeyInput } from '@/components/chat'
       - { useSettingsStore } from '@/stores'

    2. Inside ManagerDetail component:
       - Get apiKey from useSettingsStore
       - Call useChat(managerId) hook to get sendMessage, suggestions, isReady
       - Create handleSuggestionClick callback that calls sendMessage(suggestion)

    3. Add Chat section after Sources Footer (inside the manager-found block):
       - Section with border-t border-border pt-6 mt-8
       - Heading: "Ask Anything About {manager.name}" (text-xl font-semibold)
       - If !apiKey, show ApiKeyInput component with prompt "Enter your Anthropic API key to enable AI chat"
       - If apiKey, show ChatThread component with onSuggestionClick={handleSuggestionClick}
       - Add some empty state text when no messages: "Ask a question using the input below"

    4. The existing AskInput in AppLayout pinned footer will be wired in Task 3
  </action>
  <verify>
    - `grep "useChat" src/pages/ManagerDetail/ManagerDetail.jsx` shows hook usage
    - `grep "ChatThread" src/pages/ManagerDetail/ManagerDetail.jsx` shows component
    - `grep "ApiKeyInput" src/pages/ManagerDetail/ManagerDetail.jsx` shows API key prompt
    - `grep "Ask Anything" src/pages/ManagerDetail/ManagerDetail.jsx` shows section heading
  </verify>
  <done>
    ManagerDetail page displays ChatThread below data sections with API key entry when needed.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire AppLayout AskInput to chat system</name>
  <files>src/layouts/AppLayout.jsx</files>
  <action>
    1. Add imports:
       - { useLocation, useParams } from 'react-router'
       - { useChatStore, useSettingsStore } from '@/stores'
       - { createClaudeClient, SYSTEM_PROMPT } from '@/lib/claude'
       - { managers, feedbackLog, getSummaryByManager } from '@/data'

    2. Inside AppLayout component:
       - Get apiKey from useSettingsStore
       - Get location from useLocation()
       - Get chat actions from useChatStore: addUserMessage, startStreaming, appendStreamingContent, completeStreaming, setError

    3. Create buildContext helper (copy from useChat or import if refactored):
       - For now, inline a simplified version or import buildContext from a shared location
       - Note: Could refactor buildContext to lib/claude.js in future, but for MVP keep in both places

    4. Update handleAskSubmit function:
       - Check if on manager detail page: location.pathname starts with '/manager/'
       - Extract managerId from pathname if on detail page
       - If !apiKey:
         - Show alert: "Please enter your Anthropic API key first. Go to any manager page to configure."
         - Return early
       - Call addUserMessage(question)
       - Create client via createClaudeClient(apiKey)
       - Build context (simplified: just manager overview + recent feedback, no specific manager context for dashboard asks)
       - Start streaming, call API, handle events same as useChat
       - On complete, call completeStreaming with extracted suggestions
       - Wrap in try/catch with setError

    5. Note: This creates a parallel path for chat from the pinned input. The ChatThread component in ManagerDetail will show the same messages since they share useChatStore.
  </action>
  <verify>
    - `grep "useChatStore" src/layouts/AppLayout.jsx` shows store usage
    - `grep "createClaudeClient" src/layouts/AppLayout.jsx` shows API call
    - `grep "startStreaming" src/layouts/AppLayout.jsx` shows streaming flow
    - `npm run build` succeeds
  </verify>
  <done>
    AppLayout AskInput sends questions to Claude API with streaming, updates shared chat store visible in ManagerDetail.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:
1. `npm run build` succeeds with no errors
2. `npm run dev` and navigate to a manager detail page
3. Enter API key in ApiKeyInput (get key from console.anthropic.com)
4. Type question in pinned AskInput and submit
5. Verify streaming response appears in ChatThread
6. Verify citations render as clickable buttons
7. Verify clicking citation opens CitationModal (from Phase 5)
8. Verify follow-up suggestions appear and work
9. Verify multiple questions work in same session
</verification>

<success_criteria>
- ApiKeyInput allows entering and managing API key
- API key persists in localStorage across refreshes
- ManagerDetail shows ChatThread with conversation
- AppLayout AskInput sends questions to Claude API
- Streaming responses display incrementally
- Citations parse and render as clickable buttons
- Follow-up suggestions appear and send questions when clicked
- Conversation history preserved within session
- Build passes with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-claude-integration/06-03-SUMMARY.md`
</output>
