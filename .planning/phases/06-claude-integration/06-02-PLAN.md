---
phase: 06-claude-integration
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/hooks/useChat.js
  - src/components/chat/ChatThread/ChatThread.jsx
  - src/components/chat/ChatThread/index.js
  - src/components/chat/ChatMessage/ChatMessage.jsx
  - src/components/chat/ChatMessage/index.js
  - src/components/chat/MessageContent/MessageContent.jsx
  - src/components/chat/MessageContent/index.js
  - src/components/chat/FollowUpSuggestions/FollowUpSuggestions.jsx
  - src/components/chat/FollowUpSuggestions/index.js
  - src/components/chat/index.js
autonomous: true

must_haves:
  truths:
    - "useChat hook sends messages to Claude API with streaming"
    - "ChatThread renders conversation messages and streaming indicator"
    - "MessageContent parses [-> CALL-XXXX] and renders Citation components"
    - "FollowUpSuggestions displays clickable suggestion chips"
    - "Streaming text appears incrementally as Claude responds"
  artifacts:
    - path: "src/hooks/useChat.js"
      provides: "Custom hook wrapping Anthropic streaming API"
      exports: ["useChat"]
    - path: "src/components/chat/ChatThread/ChatThread.jsx"
      provides: "Conversation thread container with auto-scroll"
      exports: ["ChatThread"]
    - path: "src/components/chat/MessageContent/MessageContent.jsx"
      provides: "Text renderer with inline citations"
      exports: ["MessageContent"]
    - path: "src/components/chat/FollowUpSuggestions/FollowUpSuggestions.jsx"
      provides: "Clickable follow-up chips"
      exports: ["FollowUpSuggestions"]
  key_links:
    - from: "src/hooks/useChat.js"
      to: "src/lib/claude.js"
      via: "createClaudeClient import"
      pattern: "createClaudeClient"
    - from: "src/hooks/useChat.js"
      to: "src/stores/chatStore.js"
      via: "useChatStore subscription"
      pattern: "useChatStore"
    - from: "src/components/chat/MessageContent/MessageContent.jsx"
      to: "src/components/display/Citation/Citation.jsx"
      via: "Citation component import"
      pattern: "import.*Citation.*from"
---

<objective>
Create useChat hook for Anthropic API streaming and chat UI components for rendering conversation thread with inline citations.

Purpose: Implements core chat functionality - streaming responses, citation rendering, and follow-up suggestions.
Output: Complete chat component library ready to wire into ManagerDetail page in Plan 03.
</objective>

<execution_context>
@/Users/ericgreene/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ericgreene/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-claude-integration/06-RESEARCH.md
@.planning/phases/06-claude-integration/06-01-SUMMARY.md
@src/stores/chatStore.js
@src/stores/settingsStore.js
@src/lib/claude.js
@src/data/index.js
@src/components/display/Citation/Citation.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useChat hook with Anthropic streaming</name>
  <files>src/hooks/useChat.js</files>
  <action>
    Create src/hooks/useChat.js:

    1. Import dependencies:
       - useCallback from 'react'
       - useChatStore, useSettingsStore from '@/stores'
       - createClaudeClient, SYSTEM_PROMPT from '@/lib/claude'
       - managers, feedbackLog, getSummaryByManager from '@/data'

    2. Create buildContext(managerId = null) helper function:
       - Build managerData array with name, region, quota_attainment, coaching_score, trend, summary for each manager
       - Start context string with "## Manager Overview\n" + JSON.stringify(managerData)
       - If managerId provided, get summary via getSummaryByManager and add "## Detailed Summary" section
       - Add "## Recent Feedback (cite using [-> CALL-XXXX])" section with 10 most recent feedback entries (call_id, manager, ae, date, truncated feedback)
       - Return context string

    3. Export useChat(managerId = null) hook:
       - Get apiKey from useSettingsStore
       - Get all state and actions from useChatStore
       - Create sendMessage(userContent) async callback:
         - Return early with setError if !apiKey
         - Call addUserMessage(userContent)
         - Create client via createClaudeClient(apiKey)
         - Build context via buildContext(managerId)
         - Build conversationMessages from messages array (role, content)
         - Add current user message with context prepended
         - Call startStreaming()
         - Create stream via client.messages.stream() with:
           - model: 'claude-sonnet-4-5-20250929'
           - max_tokens: 1024
           - system: SYSTEM_PROMPT
           - messages: conversationMessages
         - Listen to stream.on('text', callback) and call appendStreamingContent
         - await stream.finalMessage()
         - Extract suggestions from streamingContent using regex for "follow-up questions" section
         - Call completeStreaming(extractedSuggestions)
         - Wrap in try/catch, call setError on failure

    4. Return object with:
       - messages, streamingContent, status, error, suggestions
       - sendMessage, clearConversation
       - isReady: !!apiKey

    Reference Pattern 4 from 06-RESEARCH.md for exact implementation details.
  </action>
  <verify>
    - `grep "client.messages.stream" src/hooks/useChat.js` shows streaming call
    - `grep "stream.on.*text" src/hooks/useChat.js` shows event handler
    - `grep "buildContext" src/hooks/useChat.js` shows context builder
    - `grep "Follow-up questions" src/hooks/useChat.js` shows suggestion extraction (case-insensitive)
  </verify>
  <done>
    useChat hook orchestrates Claude API streaming, context building, and store updates.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create chat UI components</name>
  <files>
    src/components/chat/ChatThread/ChatThread.jsx
    src/components/chat/ChatThread/index.js
    src/components/chat/ChatMessage/ChatMessage.jsx
    src/components/chat/ChatMessage/index.js
    src/components/chat/MessageContent/MessageContent.jsx
    src/components/chat/MessageContent/index.js
    src/components/chat/FollowUpSuggestions/FollowUpSuggestions.jsx
    src/components/chat/FollowUpSuggestions/index.js
    src/components/chat/index.js
  </files>
  <action>
    Create chat components directory and files:

    1. src/components/chat/MessageContent/MessageContent.jsx:
       - Import Fragment from 'react'
       - Import Citation from '@/components/display'
       - Accept content prop
       - Define citationPattern regex: /(\[(?:->|->)\s*CALL-\d{4}\]|CALL-\d{4})/g
       - Split content by pattern
       - Map parts: if matches CALL-XXXX pattern, render Citation component; else render text with line breaks
       - Return div with prose styling
       - Reference Pattern 5 from 06-RESEARCH.md

    2. src/components/chat/ChatMessage/ChatMessage.jsx:
       - Accept message prop { id, role, content } and isStreaming prop
       - Render different styles for user vs assistant:
         - User: bg-gray-100 rounded-lg p-4, aligned right
         - Assistant: bg-white p-4, aligned left
       - For assistant messages, render MessageContent component
       - For user messages, render content directly
       - Add subtle streaming indicator (opacity pulse) when isStreaming

    3. src/components/chat/FollowUpSuggestions/FollowUpSuggestions.jsx:
       - Accept suggestions array and onClick callback
       - Render horizontal flex-wrap container
       - Map suggestions to clickable chips:
         - Style: bg-gray-100 hover:bg-gray-200 rounded-full px-4 py-2 text-sm cursor-pointer
         - onClick calls the onClick callback with suggestion text
       - Return null if suggestions empty

    4. src/components/chat/ChatThread/ChatThread.jsx:
       - Import useRef, useEffect from 'react'
       - Import ChatMessage, FollowUpSuggestions siblings
       - Import useChatStore from '@/stores'
       - Accept onSuggestionClick callback prop
       - Get messages, streamingContent, status, suggestions, error from store
       - Create bottomRef for auto-scroll
       - useEffect to scroll to bottom on messages/streamingContent change
       - Render:
         - Map messages to ChatMessage components
         - If status === 'streaming' && streamingContent, render streaming ChatMessage
         - If status === 'loading', render typing indicator (animated dots + "Analyzing...")
         - If status === 'idle' && suggestions.length > 0, render FollowUpSuggestions
         - If status === 'error', render error message in red
         - Ref div at bottom for scroll target
       - Reference Pattern 6 from 06-RESEARCH.md

    5. Create index.js barrel exports for each component directory

    6. Create src/components/chat/index.js exporting all components
  </action>
  <verify>
    - `ls src/components/chat/` shows all component directories
    - `grep "Citation" src/components/chat/MessageContent/MessageContent.jsx` shows citation rendering
    - `grep "scrollIntoView" src/components/chat/ChatThread/ChatThread.jsx` shows auto-scroll
    - `grep "isStreaming" src/components/chat/ChatMessage/ChatMessage.jsx` shows streaming state
  </verify>
  <done>
    ChatThread, ChatMessage, MessageContent, and FollowUpSuggestions components render conversation with inline citations and suggestions.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:
1. `npm run build` succeeds with no errors
2. All chat components export correctly
3. useChat hook is importable from '@/hooks/useChat'
4. Components are ready for integration in Plan 03
</verification>

<success_criteria>
- useChat hook handles API streaming with proper error handling
- ChatThread renders messages with auto-scroll to bottom
- MessageContent parses [-> CALL-XXXX] citations and renders Citation components
- FollowUpSuggestions displays clickable suggestion chips
- ChatMessage distinguishes user vs assistant styling with streaming indicator
- Build passes with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-claude-integration/06-02-SUMMARY.md`
</output>
